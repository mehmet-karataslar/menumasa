<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Masa Men√º - Restoran ve kafe i≈ületmeleri i√ßin QR kod tabanlƒ± dijital men√º √ß√∂z√ºm√º. Kolay kurulum, indirim y√∂netimi ve m√º≈üteri deneyimi.">
  <meta name="keywords" content="dijital men√º, QR kod men√º, restoran men√º, kafe men√º, mobil men√º, masa men√º">
  <meta name="author" content="Masa Men√º">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Open Graph tags -->
  <meta property="og:title" content="Masa Men√º - Dijital Men√º √á√∂z√ºm√º">
  <meta property="og:description" content="QR kod ile dijital men√º sistemi. Restoran ve kafeler i√ßin modern √ß√∂z√ºm.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="icons/Icon-512.png">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Masa Men√º">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>Masa Men√º - Dijital Men√º √á√∂z√ºm√º</title>
  <link rel="manifest" href="manifest.json">
  
  <!-- QR Menu compatible routing script -->
  <script>
// Enhanced QR Menu and normal route handler
window.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ Enhanced QR Route Handler initialized');
  
  // Get current URL info
  const currentPath = window.location.pathname;
  const currentSearch = window.location.search;
  const searchParams = new URLSearchParams(currentSearch);
  
  console.log('üìç Current path:', currentPath);
  console.log('üìç Current search:', currentSearch);
  
  // Enhanced QR menu URL detection - unified patterns
  const isQRMenuURL = currentPath.includes('/menu/') ||
                     currentPath.includes('/qr-menu/') ||
                     currentPath === '/qr' ||
                     currentPath.startsWith('/qr?') ||
                     currentPath === '/universal-qr' ||
                     searchParams.has('business') ||
                     searchParams.has('businessId') ||
                     currentSearch.includes('business=') ||
                     currentSearch.includes('businessId=');
  
  console.log('üîç QR Detection Result:', {
    path: currentPath,
    search: currentSearch,
    isQRMenu: isQRMenuURL,
    hasBusiness: searchParams.has('business'),
    hasBusinessId: searchParams.has('businessId')
  });
  
  // Extract business info for QR URLs
  let businessId = null;
  let tableNumber = null;
  
  if (isQRMenuURL) {
    // Method 1: From query parameters
    businessId = searchParams.get('business') || searchParams.get('businessId');
    tableNumber = searchParams.get('table') || searchParams.get('tableNumber');
    
    // Method 2: From path parameters (e.g., /qr-menu/businessId)
    if (!businessId && currentPath.includes('/qr-menu/')) {
      const pathParts = currentPath.split('/qr-menu/');
      if (pathParts.length > 1) {
        businessId = pathParts[1].split('?')[0].split('/')[0];
      }
    }
    
    // Method 3: From path parameters (e.g., /menu/businessId)
    if (!businessId && currentPath.includes('/menu/')) {
      const pathParts = currentPath.split('/menu/');
      if (pathParts.length > 1) {
        businessId = pathParts[1].split('?')[0].split('/')[0];
      }
    }
    
    console.log('üéØ Extracted QR parameters:', {
      businessId: businessId,
      tableNumber: tableNumber,
      source: businessId ? 'success' : 'failed'
    });
  }
  
  // Don't redirect QR menu URLs - let Flutter handle them
  if (isQRMenuURL) {
    console.log('‚úÖ QR Menu URL detected, preserving route:', currentPath + currentSearch);
    
    // Enhanced Flutter accessibility with validation
    window.qrRouteInfo = {
      originalPath: currentPath,
      originalSearch: currentSearch,
      businessId: businessId,
      tableNumber: tableNumber ? parseInt(tableNumber) : null,
      timestamp: Date.now(),
      isValid: businessId ? true : false,
      source: 'web_router'
    };
    
    // If no businessId found, log warning but still allow the route
    if (!businessId) {
      console.warn('‚ö†Ô∏è QR URL detected but no businessId found:', currentPath + currentSearch);
      console.log('üîÑ Will let Flutter router handle parameter extraction...');
    } else {
      console.log('‚úÖ Business ID extracted successfully:', businessId);
    }
    
         // Normalize the route for Flutter router - only for QR menu access
     if (currentPath !== '/qr' && !currentPath.startsWith('/qr?')) {
       // Only normalize direct menu access (not sub-pages like cart, order)
       const isDirectMenuAccess = currentPath.match(/^\/menu\/[^\/]+\/?$/) || 
                                 currentPath.match(/^\/qr-menu\/[^\/]+\/?$/);
       
       if (isDirectMenuAccess && businessId) {
         // Convert legacy paths to standard /qr format
         let normalizedUrl = '/qr';
         const params = new URLSearchParams();
         
         params.set('business', businessId);
         if (tableNumber) params.set('table', tableNumber);
         
         // Add any other existing parameters (except timestamp)
         for (const [key, value] of searchParams.entries()) {
           if (key !== 'business' && key !== 'businessId' && 
               key !== 'table' && key !== 'tableNumber' && 
               key !== 't' && key !== 'timestamp') {
             params.set(key, value);
           }
         }
         
         if (params.toString()) {
           normalizedUrl += '?' + params.toString();
         }
         
         console.log('üîÑ Normalizing QR URL from:', currentPath + currentSearch);
         console.log('üîÑ To:', normalizedUrl);
         
         // Update URL without reload
         window.history.replaceState(null, '', normalizedUrl);
       } else if (!isDirectMenuAccess) {
         console.log('‚úÖ Sub-page URL detected, preserving original route:', currentPath);
       }
     }
    
    return; // Don't interfere with QR routes
  }
  
  // Clear cache for non-QR URLs
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(function(registrations) {
      for(let registration of registrations) {
        registration.update();
      }
    });
  }
  
  // Handle hash routing only for non-QR URLs
  if (window.location.hash && !isQRMenuURL) {
    const hash = window.location.hash.substring(1);
    const path = hash.split('?')[0];
    
    // Check if hash contains QR menu path
    if (path.includes('/menu/') || path.includes('/qr-menu/') || path.includes('/qr') || path.includes('/universal-qr')) {
      console.log('‚úÖ QR Menu hash detected, preserving:', hash);
      return; // Don't redirect QR menu paths
    }
    
    // Only redirect non-QR hash routes
    if (path && path !== '/') {
      console.log('üîÑ Redirecting hash route to:', path);
      window.history.replaceState(null, '', path + window.location.search);
    }
  }
});

// Enhanced hash change handler
window.addEventListener('hashchange', function() {
  const hash = window.location.hash.substring(1);
  const path = hash.split('?')[0];
  
  // Don't interfere with QR menu URLs
  if (path && (path.includes('/menu/') || path.includes('/qr-menu/') || path.includes('/qr') || path.includes('/universal-qr'))) {
    console.log('‚úÖ QR Menu hash change detected, preserving:', hash);
    return;
  }
  
  // Handle normal hash changes
  if (path && path !== window.location.pathname) {
    console.log('üîÑ Hash change redirect to:', path);
    window.history.replaceState(null, '', path + window.location.search);
  }
});

// QR URL helper function for Flutter
window.getQRRouteInfo = function() {
  return window.qrRouteInfo || null;
};

// Enhanced QR URL validator
window.validateQRUrl = function(url) {
  try {
    const uri = new URL(url, window.location.origin);
    const hasBusinessParam = uri.searchParams.has('business') || uri.searchParams.has('businessId');
    const hasQRPath = uri.pathname.includes('/menu/') || 
                     uri.pathname.includes('/qr-menu/') || 
                     uri.pathname === '/qr' ||
                     uri.pathname === '/universal-qr';
    
    // Extract businessId from path if not in params
    let businessId = uri.searchParams.get('business') || uri.searchParams.get('businessId');
    
    if (!businessId && uri.pathname.includes('/qr-menu/')) {
      const pathParts = uri.pathname.split('/qr-menu/');
      if (pathParts.length > 1) {
        businessId = pathParts[1].split('?')[0].split('/')[0];
      }
    }
    
    if (!businessId && uri.pathname.includes('/menu/')) {
      const pathParts = uri.pathname.split('/menu/');
      if (pathParts.length > 1) {
        businessId = pathParts[1].split('?')[0].split('/')[0];
      }
    }
    
    const result = {
      isValid: hasBusinessParam || hasQRPath,
      businessId: businessId,
      tableNumber: uri.searchParams.get('table') || uri.searchParams.get('tableNumber'),
      originalUrl: url,
      pathType: hasQRPath ? 'path' : 'query',
      normalizedUrl: businessId ? `/qr?business=${businessId}${uri.searchParams.get('table') ? `&table=${uri.searchParams.get('table')}` : ''}` : null
    };
    
    console.log('üîç QR URL Validation Result:', result);
    return result;
  } catch (e) {
    console.error('QR URL validation error:', e);
    return { isValid: false, error: e.message };
  }
};

// Additional helper for debugging
window.debugQRRoute = function() {
  const info = window.getQRRouteInfo();
  console.log('üêõ Current QR Route Info:', info);
  return info;
};
</script>
</head>
<body>
  <script src="flutter_bootstrap.js" async></script>
</body>
</html> 